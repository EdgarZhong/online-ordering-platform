flowchart TD
    subgraph 消费者前端
        A[浏览餐厅/菜单/菜单项]
        C[加入购物车]
        D[进入结算]
    end
    subgraph 后端 API
        R1[GET /api/restaurants]
        R2[GET /api/restaurants/:id/menus]
        R3[GET /api/menus/:menuId/items <br/> 返回: X-Menu-Version/Signature/ETag]
        O1[POST /api/orders]
        O2[GET /api/orders/:orderId]
        O3[GET /api/orders]
        O4[POST /api/orders/:orderId/cancel]
    end
    subgraph 数据库
        T1[restaurants/users/menus/menu_items/dishes]
        T2[orders/order_items]
    end
    subgraph 事件
        EBus[KitchenEventBus]
    end

    A --> R1 --> R2 --> R3
    R3 --> C --> D
    D -->|未登录| L[login.jsp] --> P[LoginServlet]
    D -->|已登录| O1
    O1 --> S{校验与事务}
    S -->|通过| T2
    T2 --> EBus --> K[201 Created 返回 orderId/status/totalPrice]
    S -->|失败| F[400/409/500]
    K --> O2
    O2 --> O3
    O2 --> O4